<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Piratwhist ‚Äì Regler v1.0</title>
  <link rel="stylesheet" href="piratwhist.css" />
  <link rel="stylesheet" href="/feedback.css" />
</head>
<body class="page-rules">
  <header class="topbar">
    <div class="title">
      Piratwhist ‚Äì Regler <span class="badge">v1.0</span>
    </div>
    <div class="actions">
      <button id="rulesBack" class="ghost linkbtn" type="button">‚Üê Tilbage</button>
      <!-- Admin-link: skal KUN v√¶re synlig for spillernavn "LaBA" (robust skjul ogs√• uden JS). -->
      <a id="rulesAdmin" class="ghost linkbtn" href="/admin.html" hidden style="display:none">Admin</a>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Regler (g√¶lder for b√•de fysisk og online spil)</h2>
      <p>
        Piratwhist er et whist-lignende stikspil for <strong>2‚Äì8 spillere</strong> med bud.
        Reglerne er de samme i <strong>fysisk spil</strong> og <strong>online spil</strong> ‚Äî forskellen er kun,
        hvordan bud, stik og point registreres.
      </p>

      <h2>Grundregler</h2>
      <ul>
        <li><strong>Spar (‚ô†) er altid trumf</strong>.</li>
        <li>Man skal <strong>bekende kul√∏r</strong>, hvis man kan.</li>
        <li>Hvis man ikke kan bekende kul√∏r, m√• man spille et hvilket som helst kort.</li>
        <li>H√∏jeste kort vinder stikket i den udspillede kul√∏r, medmindre der spilles trumf.</li>
      </ul>

      <h2>Robot: L√¶s reglerne op (kort og simpelt)</h2>
      <div class="rules-robot" aria-live="polite">
        <p class="hint">Tryk p√• knappen, s√• f√•r du en kort og enkel opl√¶sning af reglerne.</p>
        <div class="rules-robot-actions">
          <button id="rulesRobotSpeak" class="primary" type="button">ü§ñ L√¶s regler op</button>
          <button id="rulesRobotStop" class="ghost" type="button">Stop</button>
          <span id="rulesRobotStatus" class="rules-robot-status">Klar.</span>
        </div>
        <ul class="rules-robot-list">
          <li>Spar er altid trumf.</li>
          <li>Bekend kul√∏r hvis du kan.</li>
          <li>H√∏jeste kort vinder stikket (medmindre trumf er spillet).</li>
          <li>F√∏r runden byder du, hvor mange stik du tror du vinder.</li>
          <li>Rammer du dit bud: 10 point + bud. Ellers minus pr. fejlstik.</li>
        </ul>
      </div>

      <h2>Runder og antal kort (52-korts begr√¶nsning)</h2>
      <ul>
        <li>Der bruges √©t standard spil (52 kort).</li>
        <li>Antal kort pr. spiller i en runde m√• aldrig overstige <code>floor(52 / antal spillere)</code>.</li>
        <li>Der er altid mindst 1 kort pr. spiller.</li>
      </ul>

      <h2>Tur-r√¶kkef√∏lge (FAST)</h2>
      <ul>
        <li><strong>Kortomgangen g√•r altid med uret (clockwise)</strong> set oppefra ‚Äî p√• b√•de mobil og PC.</li>
        <li>I f√∏rste stik i en runde l√¶gger en ny spiller ud (roterer fra runde til runde).</li>
        <li>Vinderen af et stik l√¶gger ud i n√¶ste stik.</li>
      </ul>

      <div class="rule-figure">
        <iframe class="rule-illustration" src="online_play.html?guide=1&scene=clockwise&clean=1" loading="lazy" title="Illustration: R√¶kkef√∏lge med uret (clockwise)"></iframe>
        <div class="figcap">Illustration: R√¶kkef√∏lge med uret (clockwise)</div>
      </div>

      <h2>Budfase</h2>
      <p>
        F√∏r en runde spilles, afgiver hver spiller et bud p√•, hvor mange stik de forventer at vinde i runden.
        Bud kan v√¶re fra <strong>0</strong> til <strong>antal kort p√• h√•nden</strong>.
      </p>

      <div class="rule-figure">
        <iframe class="rule-illustration" src="online_bidding.html?guide=1&scene=normal_bidding&clean=1" loading="lazy" title="Illustration: Budfase (normal runde)"></iframe>
        <div class="figcap">Illustration: Budfase (normal runde)</div>
      </div>

      <h2>S√¶rregel: Runde med 1 kort pr. spiller</h2>
      <p>
        N√•r der kun deles <strong>1 kort pr. spiller</strong>, g√¶lder en s√¶rlig informationsregel <em>f√∏r bud</em>:
      </p>
      <ul>
        <li>Du kan <strong>ikke se dit eget kort</strong> f√∏r bud (dit kort er skjult/bagside).</li>
        <li>Du kan <strong>se alle modstanderes kort</strong> f√∏r bud (forsider vises).</li>
        <li>Reglen g√¶lder for <strong>alle spillere</strong> (symmetrisk).</li>
      </ul>

      <div class="rule-figure">
        <iframe class="rule-illustration" src="online_bidding.html?guide=1&scene=onecard&clean=1" loading="lazy" title="Illustration: 1-korts-runde (du ser ikke dit eget kort f√∏r bud)"></iframe>
        <div class="figcap">Illustration: 1-korts-runde (du ser ikke dit eget kort f√∏r bud)</div>
      </div>

      <h2>Spil af stik</h2>
      <ul>
        <li>Spillerne spiller √©t kort ad gangen i tur-r√¶kkef√∏lge.</li>
        <li>Man skal bekende kul√∏r, hvis muligt.</li>
        <li>Stikket vindes af h√∏jeste trumf (hvis trumf er spillet), ellers h√∏jeste kort i udspillet kul√∏r.</li>
      </ul>

      <div class="rule-figure">
        <iframe class="rule-illustration" src="online_play.html?guide=1&scene=trumpwin&clean=1" loading="lazy" title="Illustration: Trumf (‚ô†) vinder stikket"></iframe>
        <div class="figcap">Illustration: Trumf (‚ô†) vinder stikket</div>
      </div>

      <h2>Point</h2>
      <ul>
        <li>Hvis du rammer dit bud pr√¶cist: <strong>10 point + dit bud</strong>.</li>
        <li>Hvis du ikke rammer dit bud: <strong>-abs(stik - bud)</strong> point (negativt for hver stik du er fra).</li>
        <li>Totalscoren er summen af alle runder.</li>
      </ul>

      <h2>Resultatoversigt</h2>
      <p>
        Pointoversigten viser √©n samlet tabel:
      </p>
      <ul>
        <li><strong>Total</strong> ligger √∏verst og viser <em>kun point</em>.</li>
        <li>Dern√¶st vises runder med <strong>seneste runde √∏verst</strong>.</li>
        <li>Format pr. runde pr. spiller: <code>Bud / Stik (Point)</code>.</li>
      </ul>

      <div class="rule-figure">
        <iframe class="rule-illustration" src="online_play.html?guide=1&scene=scoretable&clean=1" loading="lazy" title="Illustration: Pointoversigt (Total √∏verst, seneste runde √∏verst)"></iframe>
        <div class="figcap">Illustration: Pointoversigt (Total √∏verst, seneste runde √∏verst)</div>
      </div>


      <h2>Fysisk spil ‚Äì indtastning (KUN fysisk spil)</h2>
      <p>
        I fysisk spil bruger du appen som scoretavle. Her indtastes <strong>bud</strong> og <strong>stik</strong>
        manuelt, og appen beregner point og totaler.
        <strong>Disse indtastninger er ikke relevante i online spil</strong>.
      </p>

      <h2>Online spil ‚Äì automatisk</h2>
      <p>
        I online spil h√•ndterer spillet automatisk kort, bud, stik og point. Du skal kun afgive bud og spille kort.
      </p>
    </section>
  </main>

  <footer class="footer">
    Piratwhist v1.0
  </footer>

  <script>
    (function(){
      function sameOrigin(url){
        try { return new URL(url, window.location.href).origin === window.location.origin; } catch(e){ return false; }
      }
      function getParam(name){
        try { return new URLSearchParams(window.location.search).get(name); } catch(e){ return null; }
      }
      const fromParam = getParam('from');
      let storedReturn = null;
      try { storedReturn = sessionStorage.getItem('pw_rules_return'); } catch(_) { storedReturn = null; }
      let fallback = 'piratwhist.html';
      if (storedReturn && sameOrigin(storedReturn)) {
        fallback = storedReturn;
      } else if (fromParam) {
        try { fallback = decodeURIComponent(fromParam); } catch(e){ fallback = fromParam; }
      } else if (document.referrer && sameOrigin(document.referrer)) {
        fallback = document.referrer;
      }

      document.getElementById('rulesBack')?.addEventListener('click', () => {
        // Preferred: browser back (returns to the exact state, incl. mid-game).
        if (document.referrer && sameOrigin(document.referrer) && history.length > 1) {
          history.back();
          return;
        }
        // Fallback: explicit URL.
        window.location.href = fallback;
      });

      // Clear stored return once we've used the rules page (prevents stale returns later)
      try { sessionStorage.removeItem('pw_rules_return'); } catch(_) {}

      // If the rules page was opened in a new tab, the user might "close" the tab.
      // Provide a safe close attempt via ESC (optional):
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          try { window.close(); } catch(_) {}
          // If closing is blocked, navigate back instead.
          window.location.href = fallback;
        }
      });

      function getStoredName(){
        try { return (localStorage.getItem("pw_player_name") || "").trim(); } catch(e){ return ""; }
      }
      const adminLink = document.getElementById('rulesAdmin');
      if (adminLink){
        const name = getStoredName();
        const isAdmin = name === 'LaBA';
        // Dobbelt-sikring: b√•de hidden-attribut og inline display.
        adminLink.hidden = !isAdmin;
        adminLink.style.display = isAdmin ? '' : 'none';
      }

      const robotSpeakBtn = document.getElementById('rulesRobotSpeak');
      const robotStopBtn = document.getElementById('rulesRobotStop');
      const robotStatus = document.getElementById('rulesRobotStatus');
      const simpleRulesText = [
        'Her er reglerne helt kort.',
        'Spar er altid trumf.',
        'Du skal bekende kul√∏r, hvis du kan.',
        'H√∏jeste kort vinder stikket, medmindre trumf er spillet.',
        'F√∏r hver runde byder du, hvor mange stik du forventer.',
        'Rammer du dit bud f√•r du ti point plus buddet.',
        'Ellers mister du point for hvert stik du rammer forkert.'
      ].join(' ');

      function setRobotStatus(text){
        if (robotStatus) {
          robotStatus.textContent = text;
        }
      }

      function stopRobot(){
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
        }
        setRobotStatus('Stoppet.');
      }

      function speakRules(){
        if (!('speechSynthesis' in window)) {
          setRobotStatus('Opl√¶sning underst√∏ttes ikke i denne browser.');
          return;
        }
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(simpleRulesText);
        utterance.lang = 'da-DK';
        utterance.rate = 1;
        utterance.pitch = 1;
        utterance.onstart = () => setRobotStatus('Robotten l√¶ser op‚Ä¶');
        utterance.onend = () => setRobotStatus('F√¶rdig.');
        utterance.onerror = () => setRobotStatus('Kunne ikke l√¶se op.');
        window.speechSynthesis.speak(utterance);
      }

      if (robotSpeakBtn && robotStopBtn) {
        if (!('speechSynthesis' in window)) {
          robotSpeakBtn.disabled = true;
          setRobotStatus('Opl√¶sning underst√∏ttes ikke i denne browser.');
        }
        robotSpeakBtn.addEventListener('click', speakRules);
        robotStopBtn.addEventListener('click', stopRobot);
        window.addEventListener('beforeunload', () => {
          if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
          }
        });
      }
    })();
  </script>
  <script src="/pw_telemetry.js"></script>
  <script src="/feedback.js"></script>
</body>
</html>
